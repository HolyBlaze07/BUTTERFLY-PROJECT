<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Free Online Bible Reader | Berean Standard Bible | Scripture Journal &
      Study Tool
    </title>
    <meta
      name="description"
      content="Read the Berean Standard Bible online for free. Interactive Bible reader with chapter navigation, verse bookmarks, reading history, progress tracking, and scripture journaling. Beautiful Y2K-inspired design. Perfect for daily devotions and Bible study."
    />
    <meta
      name="keywords"
      content="Bible online, read Bible free, Berean Standard Bible, BSB, scripture reader, Bible study tool, verse bookmarks, Bible journal, daily devotions, Christian faith, Bible chapters, Bible verses, scripture study, free Bible app, online Bible study"
    />
    <meta name="theme-color" content="#00ffff" />
    <meta name="author" content="Butterfly Project" />
    <meta property="og:type" content="website" />
    <meta
      property="og:title"
      content="Free Online Bible Reader - Berean Standard Bible"
    />
    <meta property="og:site_name" content="Butterfly Bible Console" />
    <meta
      property="og:description"
      content="Read the Berean Standard Bible online for free. Interactive Bible reader with chapter navigation, verse bookmarks, reading history, and scripture journaling."
    />
    <meta property="og:image" content="../assets/Butterfly4.png" />
    <meta property="og:image:alt" content="Butterfly Bible Console Logo" />
    <meta property="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:title"
      content="Free Online Bible Reader - Berean Standard Bible"
    />
    <meta
      property="twitter:description"
      content="Interactive Bible study tool with bookmarks, journaling, and reading progress tracking. Free to use."
    />
    <meta property="twitter:image:alt" content="Butterfly Bible Console Logo" />

    <!-- Butterfly Theme System -->
    <script src="../js/butterfly-theme.js"></script>
    <link rel="stylesheet" href="../css/theme-selector.css" />
    <script src="../js/theme-selector.js" defer></script>

    <!-- Bible Page Styles -->
    <link rel="stylesheet" href="../css/butterfly-bible.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Unbounded:wght@600&display=swap"
      rel="stylesheet"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Butterfly Bible Console",
        "applicationCategory": "LifestyleApplication",
        "description": "Free online Bible reader with the Berean Standard Bible. Features include chapter navigation, verse bookmarks, reading history, progress tracking, and scripture journaling.",
        "offers": {
          "@type": "Offer",
          "price": "0",
          "priceCurrency": "USD"
        },
        "featureList": "Bible reading, Chapter navigation, Verse bookmarks, Reading history, Progress tracking, Scripture journaling",
        "operatingSystem": "Any",
        "browserRequirements": "Requires JavaScript"
      }
    </script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
      <span class="theme-toggle-icon" id="themeIcon">üåô</span>
      <span id="themeText">Dark Mode</span>
    </button>
    <div class="butterfly-field" aria-hidden="true"></div>
    <main id="main-content" role="main">
      <header role="banner">
        <a
          class="hub-link"
          href="../hub.html"
          aria-label="Return to Butterfly Hub home page"
        >
          <img
            src="../assets/Butterfly6.png"
            width="24"
            height="24"
            alt="Butterfly home icon"
            loading="lazy"
          />
          Back to Hub
        </a>
        <h1>
          <img
            src="../assets/Butterfly4.png"
            style="
              width: 32px;
              vertical-align: middle;
              image-rendering: pixelated;
              margin-right: 10px;
            "
            alt="Butterfly Bible Console icon"
            loading="eager"
          />
          Bible Console
        </h1>
        <p>
          Dive into Scripture with a sleek, modern reader! Stream any chapter
          from the Berean Standard Bible, bookmark your favorite verses, and
          track your spiritual journey‚Äîall beautifully synced with your Hub
          profile. Your faith, digitized and elevated.
        </p>
        <div class="alert">
          Berean Standard Bible text courtesy of the
          <a href="https://bible.helloao.org/" target="_blank" rel="noreferrer"
            >Free Use Bible API</a
          >. Dedicated to the public domain (CC0) ‚Äî attribution appreciated but
          not required.
        </div>
      </header>

      <div class="app-grid">
        <section class="panel controls" aria-label="Bible navigation controls">
          <h2>Navigator</h2>
          <label for="translation-select">
            <span>Translation</span>
            <select
              id="translation-select"
              aria-label="Select Bible translation"
            ></select>
          </label>
          <label for="book-search">
            <span>Search Books</span>
            <input
              type="search"
              id="book-search"
              placeholder="Filter by name"
              aria-label="Search for Bible books by name"
            />
          </label>
          <div
            class="status-pill"
            id="status-pill"
            role="status"
            aria-live="polite"
          >
            Connecting‚Ä¶
          </div>
          <div
            class="book-grid"
            id="book-grid"
            role="region"
            aria-label="Bible books list"
            aria-live="polite"
          ></div>
        </section>

        <section
          class="panel chapter-reader"
          aria-label="Bible chapter reader"
          role="region"
        >
          <div class="chapter-meta">
            <div>
              <p class="status-pill" id="chapter-label" role="status">
                Choose a book
              </p>
              <h3 id="chapter-heading">No chapter loaded</h3>
            </div>
            <div class="chapter-controls">
              <button
                class="ghost-btn"
                id="prev-chapter"
                disabled
                aria-label="Go to previous chapter"
              >
                ‚óÄ Prev
              </button>
              <button
                class="ghost-btn"
                id="next-chapter"
                disabled
                aria-label="Go to next chapter"
              >
                Next ‚ñ∂
              </button>
            </div>
          </div>
          <div
            class="chapter-content"
            id="chapter-content"
            role="article"
            aria-live="polite"
          >
            <p>Select a book to stream its opening chapter.</p>
          </div>
          <div class="chapter-controls bottom-controls">
            <button
              class="ghost-btn"
              id="prev-chapter-bottom"
              disabled
              aria-label="Go to previous chapter"
            >
              ‚óÄ Prev
            </button>
            <button
              class="ghost-btn"
              id="next-chapter-bottom"
              disabled
              aria-label="Go to next chapter"
            >
              Next ‚ñ∂
            </button>
          </div>
        </section>

        <aside
          class="panel sidebar"
          role="complementary"
          aria-label="Bookmarks, history, and progress"
        >
          <div class="bookmark-section">
            <h2
              class="bookmark-header"
              onclick="toggleBookmarks()"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="bookmark-list"
            >
              Bookmarks <span id="bookmark-toggle" aria-hidden="true">‚ñº</span>
            </h2>
            <div
              class="bookmark-list"
              id="bookmark-list"
              style="display: none"
              role="region"
              aria-label="Your saved bookmarks"
            ></div>
          </div>

          <div class="history-section">
            <h2
              class="history-header"
              onclick="toggleHistory()"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="history-list"
            >
              History <span id="history-toggle" aria-hidden="true">‚ñº</span>
            </h2>
            <div
              class="history-list"
              id="history-list"
              style="display: none"
              role="region"
              aria-label="Your reading history"
            ></div>
          </div>

          <div class="progress-section">
            <h2
              class="progress-header"
              onclick="toggleProgress()"
              role="button"
              tabindex="0"
              aria-expanded="false"
              aria-controls="progress-content"
            >
              Progress <span id="progress-toggle" aria-hidden="true">‚ñº</span>
            </h2>
            <div
              class="progress-content"
              id="progress-content"
              style="display: none"
              role="region"
              aria-label="Your reading progress"
            >
              <div
                class="progress-bar"
                role="progressbar"
                aria-valuemin="0"
                aria-valuemax="1189"
                aria-valuenow="0"
                aria-label="Chapters read progress"
              >
                <span id="progress-meter" style="width: 0%"></span>
              </div>
              <small id="progress-copy" aria-live="polite"
                >0 of 1,189 chapters logged</small
              >
            </div>
          </div>
        </aside>
      </div>

      <!-- Journal Section -->
      <section
        class="journal-section panel"
        role="region"
        aria-labelledby="journal-heading"
      >
        <div class="journal-header">
          <h2 id="journal-heading">üìñ Scripture Journal</h2>
          <div class="journal-stats">
            <span id="entry-count" aria-live="polite">0 entries</span>
          </div>
        </div>

        <form
          class="journal-form"
          onsubmit="event.preventDefault(); saveJournalEntry();"
          aria-label="Add new journal entry"
        >
          <input
            type="text"
            id="entry-title"
            placeholder="Entry Title (e.g., Genesis 1 - Creation)"
            maxlength="100"
            aria-label="Entry title"
            required
          />
          <textarea
            id="entry-description"
            placeholder="Write your reflections, prayers, and insights..."
            rows="6"
            aria-label="Entry description"
            required
          ></textarea>
          <input
            type="text"
            id="entry-tags"
            placeholder="Tags (optional, comma-separated: faith, hope, prayer)"
            aria-label="Entry tags (optional)"
          />
          <button
            class="save-entry-btn"
            type="submit"
            aria-label="Save journal entry"
          >
            üíæ Save Entry
          </button>
        </form>

        <div class="journal-entries-container">
          <h3>Journal Entries</h3>
          <div
            id="journal-entries-list"
            class="journal-entries-list"
            role="list"
            aria-label="Your journal entries"
          >
            <p class="no-entries" role="status">
              No entries yet. Start writing your first reflection!
            </p>
          </div>
        </div>
      </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div
      class="delete-modal"
      id="deleteModal"
      onclick="closeDeleteModal(event)"
      role="dialog"
      aria-modal="true"
      aria-labelledby="deleteModalTitle"
      aria-hidden="true"
    >
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 id="deleteModalTitle">‚ö†Ô∏è Delete Entry</h2>
        </div>
        <div class="modal-body">
          <p style="text-align: center; font-size: 16px; margin-bottom: 20px">
            Are you sure you want to delete this journal entry? This action
            cannot be undone.
          </p>
          <div class="modal-actions">
            <button
              class="cancel-btn"
              onclick="closeDeleteModal(event)"
              aria-label="Cancel deletion"
            >
              Cancel
            </button>
            <button
              class="confirm-delete-btn"
              onclick="confirmDelete()"
              aria-label="Confirm deletion"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chapter Selector Modal -->
    <div
      class="chapter-modal"
      id="chapterModal"
      onclick="closeChapterModal(event)"
      role="dialog"
      aria-modal="true"
      aria-labelledby="chapterModalTitle"
      aria-hidden="true"
    >
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 id="chapterModalTitle">üìñ Select Chapter</h2>
        </div>
        <div class="modal-body">
          <div
            class="chapter-grid"
            id="chapterGrid"
            role="grid"
            aria-label="Chapter selection grid"
          ></div>
        </div>
      </div>
    </div>

    <template id="journal-entry-template">
      <div class="journal-entry">
        <div class="entry-header">
          <h4 class="entry-title" data-field="title"></h4>
          <div class="entry-meta">
            <span class="entry-date" data-field="date"></span>
            <button
              class="delete-entry-btn"
              onclick="deleteJournalEntry(this)"
              aria-label="Delete entry"
            >
              ‚úï
            </button>
          </div>
        </div>
        <p class="entry-description" data-field="description"></p>
        <div class="entry-tags" data-field="tags"></div>
      </div>
    </template>

    <template id="bookmark-template">
      <div class="bookmark-item">
        <div>
          <strong data-field="title"></strong>
          <div data-field="excerpt"></div>
        </div>
        <button type="button" aria-label="Delete bookmark">‚úï</button>
      </div>
    </template>

    <script>
      const API_BASE = "https://bible.helloao.org/api";
      const DEFAULT_TRANSLATION = "BSB";

      // Theme Toggle Functionality
      function initializeTheme() {
        const themeToggle = document.getElementById("themeToggle");
        const themeIcon = document.getElementById("themeIcon");
        const themeText = document.getElementById("themeText");

        // Check for saved theme preference or default to light mode
        const savedTheme =
          localStorage.getItem("butterflyBibleTheme") || "light";

        if (savedTheme === "dark") {
          document.body.classList.add("dark-mode");
          themeIcon.textContent = "‚òÄÔ∏è";
          themeText.textContent = "Light Mode";
        }

        // Theme toggle click handler
        themeToggle.addEventListener("click", () => {
          document.body.classList.toggle("dark-mode");
          const isDark = document.body.classList.contains("dark-mode");

          // Update button
          if (isDark) {
            themeIcon.textContent = "‚òÄÔ∏è";
            themeText.textContent = "Light Mode";
            localStorage.setItem("butterflyBibleTheme", "dark");
          } else {
            themeIcon.textContent = "üåô";
            themeText.textContent = "Dark Mode";
            localStorage.setItem("butterflyBibleTheme", "light");
          }
        });

        // Keyboard accessibility
        themeToggle.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            themeToggle.click();
          }
        });
      }

      // Toggle bookmarks dropdown
      function toggleBookmarks() {
        const bookmarkList = document.getElementById("bookmark-list");
        const toggle = document.getElementById("bookmark-toggle");
        const header = document.querySelector(".bookmark-header");

        if (bookmarkList.style.display === "none") {
          bookmarkList.style.display = "flex";
          toggle.classList.add("open");
          header.setAttribute("aria-expanded", "true");
        } else {
          bookmarkList.style.display = "none";
          toggle.classList.remove("open");
          header.setAttribute("aria-expanded", "false");
        }
      }

      // Toggle history dropdown
      function toggleHistory() {
        const historyList = document.getElementById("history-list");
        const toggle = document.getElementById("history-toggle");
        const header = document.querySelector(".history-header");

        if (historyList.style.display === "none") {
          historyList.style.display = "flex";
          toggle.classList.add("open");
          header.setAttribute("aria-expanded", "true");
        } else {
          historyList.style.display = "none";
          toggle.classList.remove("open");
          header.setAttribute("aria-expanded", "false");
        }
      }

      // Toggle progress dropdown
      function toggleProgress() {
        const progressContent = document.getElementById("progress-content");
        const toggle = document.getElementById("progress-toggle");
        const header = document.querySelector(".progress-header");

        if (progressContent.style.display === "none") {
          progressContent.style.display = "flex";
          toggle.classList.add("open");
          header.setAttribute("aria-expanded", "true");
        } else {
          progressContent.style.display = "none";
          toggle.classList.remove("open");
          header.setAttribute("aria-expanded", "false");
        }
      }

      // Journal functionality
      let journalEntries = [];

      function initializeJournal() {
        // Load saved journal entries
        const savedEntries = localStorage.getItem(
          "butterflyBibleJournalEntries"
        );
        if (savedEntries) {
          journalEntries = JSON.parse(savedEntries);
          renderJournalEntries();
        }
        updateEntryCount();
      }

      function saveJournalEntry() {
        const titleInput = document.getElementById("entry-title");
        const descriptionInput = document.getElementById("entry-description");
        const tagsInput = document.getElementById("entry-tags");

        const title = titleInput.value.trim();
        const description = descriptionInput.value.trim();
        const tags = tagsInput.value.trim();

        if (!title) {
          alert("Please enter a title for your journal entry.");
          titleInput.focus();
          return;
        }

        if (!description) {
          alert("Please write your reflection in the description.");
          descriptionInput.focus();
          return;
        }

        // Create new entry
        const entry = {
          id: Date.now(),
          title: title,
          description: description,
          tags: tags
            ? tags
                .split(",")
                .map((tag) => tag.trim())
                .filter((tag) => tag)
            : [],
          date: new Date().toISOString(),
        };

        // Add to beginning of array (newest first)
        journalEntries.unshift(entry);

        // Save to localStorage
        localStorage.setItem(
          "butterflyBibleJournalEntries",
          JSON.stringify(journalEntries)
        );

        // Clear form
        titleInput.value = "";
        descriptionInput.value = "";
        tagsInput.value = "";

        // Re-render entries
        renderJournalEntries();
        updateEntryCount();

        // Scroll to entries
        document
          .querySelector(".journal-entries-container")
          .scrollIntoView({ behavior: "smooth" });
      }

      function renderJournalEntries() {
        const container = document.getElementById("journal-entries-list");
        const template = document.getElementById("journal-entry-template");

        if (journalEntries.length === 0) {
          container.innerHTML =
            '<p class="no-entries">No entries yet. Start writing your first reflection!</p>';
          return;
        }

        container.innerHTML = "";

        journalEntries.forEach((entry) => {
          const clone = template.content.cloneNode(true);

          clone.querySelector('[data-field="title"]').textContent = entry.title;
          clone.querySelector('[data-field="description"]').textContent =
            entry.description;

          const date = new Date(entry.date);
          const dateStr = date.toLocaleDateString([], {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
          clone.querySelector('[data-field="date"]').textContent = dateStr;

          const tagsContainer = clone.querySelector('[data-field="tags"]');
          if (entry.tags && entry.tags.length > 0) {
            tagsContainer.innerHTML = entry.tags
              .map((tag) => `<span class="tag">${escapeHtml(tag)}</span>`)
              .join("");
          } else {
            tagsContainer.remove();
          }

          const entryDiv = clone.querySelector(".journal-entry");
          entryDiv.dataset.id = entry.id;

          container.appendChild(clone);
        });
      }

      let entryToDelete = null;

      function deleteJournalEntry(button) {
        entryToDelete = button.closest(".journal-entry");
        const modal = document.getElementById("deleteModal");
        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeDeleteModal(event) {
        if (event) {
          event.stopPropagation();
        }
        const modal = document.getElementById("deleteModal");
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
        entryToDelete = null;
      }

      function confirmDelete() {
        if (!entryToDelete) return;

        const entryId = parseInt(entryToDelete.dataset.id);

        // Remove from array
        journalEntries = journalEntries.filter((entry) => entry.id !== entryId);

        // Save to localStorage
        localStorage.setItem(
          "butterflyBibleJournalEntries",
          JSON.stringify(journalEntries)
        );

        // Re-render
        renderJournalEntries();
        updateEntryCount();

        // Close modal
        closeDeleteModal();
      }

      function updateEntryCount() {
        const count = journalEntries.length;
        document.getElementById("entry-count").textContent = `${count} ${
          count === 1 ? "entry" : "entries"
        }`;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      const STORAGE_KEYS = {
        bookmarks: "butterflyBibleBookmarks",
        history: "butterflyBibleHistory",
        settings: "butterflyBibleSettings",
      };

      const state = {
        translations: [],
        books: [],
        translationId: DEFAULT_TRANSLATION,
        currentBook: null,
        currentChapter: null,
        nextChapterLink: null,
        prevChapterLink: null,
        bookmarks: [],
        history: [],
        user: null,
      };

      const selectors = {
        translationSelect: document.getElementById("translation-select"),
        bookSearch: document.getElementById("book-search"),
        bookGrid: document.getElementById("book-grid"),
        chapterContent: document.getElementById("chapter-content"),
        chapterLabel: document.getElementById("chapter-label"),
        chapterHeading: document.getElementById("chapter-heading"),
        prevBtn: document.getElementById("prev-chapter"),
        nextBtn: document.getElementById("next-chapter"),
        prevBtnBottom: document.getElementById("prev-chapter-bottom"),
        nextBtnBottom: document.getElementById("next-chapter-bottom"),
        statusPill: document.getElementById("status-pill"),
        bookmarkList: document.getElementById("bookmark-list"),
        historyList: document.getElementById("history-list"),
        progressMeter: document.getElementById("progress-meter"),
        progressCopy: document.getElementById("progress-copy"),
        bookmarkTemplate: document.getElementById("bookmark-template"),
        butterflyField: document.querySelector(".butterfly-field"),
      };

      document.addEventListener("DOMContentLoaded", () => {
        enforceAuth();
        hydrateButterflies();
        loadLocalData();
        initializeJournal();
        initializeTheme();
        bootstrapEvents();
        hydrateTranslations();
      });

      function enforceAuth() {
        const hubProfile = localStorage.getItem("butterflyHubCurrentUser");
        const legacyProfile = localStorage.getItem("butterflyUser");
        const rawProfile = hubProfile || legacyProfile;
        if (!rawProfile) {
          window.location.href = "butterfly-auth.html";
          return;
        }
        try {
          state.user = JSON.parse(rawProfile);
        } catch (error) {
          console.warn("Unable to parse stored profile", error);
          window.location.href = "butterfly-auth.html";
        }
      }

      function hydrateButterflies() {
        const sprites = [
          "Butterfly4.png",
          "Butterfly6.png",
          "Butterfly8.png",
          "Butterfly12.png",
        ];
        for (let i = 0; i < 9; i++) {
          const span = document.createElement("span");
          const asset = sprites[i % sprites.length];
          span.style.left = Math.random() * 100 + "%";
          span.style.bottom = Math.random() * 20 - 10 + "vh";
          span.style.animationDelay = `${Math.random() * 12}s`;
          span.style.backgroundImage = `url(../assets/${asset})`;
          selectors.butterflyField.appendChild(span);
        }
      }

      function loadLocalData() {
        state.bookmarks = JSON.parse(
          localStorage.getItem(STORAGE_KEYS.bookmarks) || "[]"
        );
        state.history = JSON.parse(
          localStorage.getItem(STORAGE_KEYS.history) || "[]"
        );
        const savedSettings = JSON.parse(
          localStorage.getItem(STORAGE_KEYS.settings) || "{}"
        );
        if (savedSettings.translationId) {
          state.translationId = savedSettings.translationId;
        }
        renderBookmarks();
        renderHistory();
        updateProgress();
      }

      function bootstrapEvents() {
        selectors.translationSelect.addEventListener("change", (e) => {
          state.translationId = e.target.value;
          persistSettings();
          loadBooks();
        });

        selectors.bookSearch.addEventListener("input", (e) => {
          renderBooks(e.target.value.trim().toLowerCase());
        });

        selectors.prevBtn.addEventListener("click", () =>
          navigateChapter(state.prevChapterLink)
        );
        selectors.nextBtn.addEventListener("click", () =>
          navigateChapter(state.nextChapterLink)
        );
        selectors.prevBtnBottom.addEventListener("click", () =>
          navigateChapter(state.prevChapterLink)
        );
        selectors.nextBtnBottom.addEventListener("click", () =>
          navigateChapter(state.nextChapterLink)
        );
      }

      async function hydrateTranslations() {
        selectors.statusPill.textContent = "Fetching translations‚Ä¶";
        try {
          const res = await fetch(`${API_BASE}/available_translations.json`);
          const payload = await res.json();
          state.translations = payload.translations || [];
          populateTranslationSelect();
          await loadBooks();
        } catch (err) {
          console.error(err);
          selectors.statusPill.textContent = "API unavailable";
        }
      }

      function populateTranslationSelect() {
        selectors.translationSelect.innerHTML = "";
        state.translations.forEach((translation) => {
          const option = document.createElement("option");
          option.value = translation.id;
          option.textContent = `${translation.shortName || translation.id} ¬∑ ${
            translation.englishName
          }`;
          if (translation.id === state.translationId) {
            option.selected = true;
          }
          selectors.translationSelect.append(option);
        });
      }

      async function loadBooks() {
        selectors.statusPill.textContent = "Loading books‚Ä¶";
        try {
          const res = await fetch(
            `${API_BASE}/${state.translationId}/books.json`
          );
          const payload = await res.json();
          state.books = payload.books || [];
          selectors.statusPill.textContent = `${
            payload.translation?.englishName || state.translationId
          } ready`;
          renderBooks();
        } catch (err) {
          console.error(err);
          selectors.statusPill.textContent = "Book list failed";
        }
      }

      function renderBooks(filter = "") {
        selectors.bookGrid.innerHTML = "";
        const filtered = state.books.filter((book) =>
          book.commonName.toLowerCase().includes(filter)
        );
        filtered.forEach((book) => {
          const btn = document.createElement("button");
          btn.className = "book-tile";
          btn.type = "button";
          btn.dataset.id = book.id;
          btn.innerHTML = `<strong>${book.commonName}</strong><span>${book.numberOfChapters} chapters</span>`;
          if (state.currentBook?.id === book.id) {
            btn.classList.add("active");
          }
          btn.addEventListener("click", () => openChapterSelector(book));
          selectors.bookGrid.append(btn);
        });
      }

      function openChapterSelector(book) {
        const modal = document.getElementById("chapterModal");
        const title = document.getElementById("chapterModalTitle");
        const grid = document.getElementById("chapterGrid");

        title.textContent = `üìñ ${book.commonName} - Select Chapter`;
        grid.innerHTML = "";

        // Create chapter buttons
        const firstChapter = book.firstChapterNumber || 1;
        for (
          let i = firstChapter;
          i < firstChapter + book.numberOfChapters;
          i++
        ) {
          const btn = document.createElement("button");
          btn.className = "chapter-btn";
          btn.textContent = i;
          btn.setAttribute(
            "aria-label",
            `Load chapter ${i} of ${book.commonName}`
          );
          btn.onclick = () => {
            loadChapter(book.id, i);
            closeChapterModal();
          };
          grid.appendChild(btn);
        }

        modal.classList.add("active");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeChapterModal(event) {
        if (event) {
          event.stopPropagation();
        }
        const modal = document.getElementById("chapterModal");
        modal.classList.remove("active");
        modal.setAttribute("aria-hidden", "true");
      }

      async function loadChapter(bookId, chapterNumber) {
        selectors.chapterContent.innerHTML = "<p>Downloading chapter‚Ä¶</p>";
        try {
          const res = await fetch(
            `${API_BASE}/${state.translationId}/${bookId}/${chapterNumber}.json`
          );
          const payload = await res.json();
          state.currentBook = payload.book;
          state.currentChapter = payload.chapter.number;
          state.nextChapterLink = payload.nextChapterApiLink;
          state.prevChapterLink = payload.previousChapterApiLink;
          selectors.chapterLabel.textContent = payload.translation.englishName;
          selectors.chapterHeading.textContent = `${payload.book.commonName} ${payload.chapter.number}`;
          renderChapter(payload.chapter);
          renderBooks(selectors.bookSearch.value.trim().toLowerCase());
          updateNavButtons();
          pushHistory(payload);
        } catch (err) {
          console.error(err);
          selectors.chapterContent.innerHTML =
            "<p>Unable to stream chapter. Please retry.</p>";
        }
      }

      function renderChapter(chapter) {
        const fragment = document.createDocumentFragment();
        chapter.content.forEach((entry) => {
          switch (entry.type) {
            case "heading":
              fragment.append(createHeading(entry.content));
              break;
            case "line_break":
              fragment.append(document.createElement("br"));
              break;
            case "hebrew_subtitle":
              fragment.append(createSubtitle(entry.content));
              break;
            case "verse":
              fragment.append(createVerse(entry));
              break;
            default:
              break;
          }
        });

        const wrapper = document.createElement("div");
        wrapper.append(fragment);

        if (chapter.footnotes?.length) {
          const footWrap = document.createElement("div");
          footWrap.className = "footnotes";
          footWrap.innerHTML = "<strong>Footnotes</strong>";
          chapter.footnotes.forEach((note) => {
            const p = document.createElement("p");
            const caller =
              note.caller && note.caller !== "+"
                ? note.caller
                : note.noteId + 1;
            p.textContent = `${caller}) ${note.text}`;
            footWrap.append(p);
          });
          wrapper.append(footWrap);
        }

        selectors.chapterContent.innerHTML = "";
        selectors.chapterContent.append(wrapper);
      }

      function createHeading(lines) {
        const el = document.createElement("h4");
        el.textContent = lines.join(" ");
        return el;
      }

      function createSubtitle(content) {
        const el = document.createElement("p");
        el.className = "subtitle";
        el.style.fontStyle = "italic";
        el.style.color = "var(--muted)";
        el.textContent = content.map(toText).join(" ");
        return el;
      }

      function createVerse(entry) {
        const el = document.createElement("div");
        el.className = "verse";
        el.dataset.verse = entry.number;
        const number = document.createElement("span");
        number.className = "verse-number";
        number.textContent = entry.number;
        el.append(number);

        const textSpan = document.createElement("span");
        textSpan.innerHTML = entry.content.map(renderContentPiece).join("");
        el.append(textSpan);

        const action = document.createElement("button");
        action.type = "button";
        action.textContent = "‚òÖ";
        action.title = "Save bookmark";
        action.addEventListener("click", () =>
          saveBookmark(entry.number, textSpan.textContent.trim())
        );
        el.append(action);

        return el;
      }

      function renderContentPiece(piece) {
        if (typeof piece === "string") return escapeHtml(piece);
        if (piece.lineBreak) return "<br />";
        if (piece.heading)
          return `<strong>${escapeHtml(piece.heading)}</strong>`;
        if (piece.text) {
          const cls = piece.poem ? ` class="poem indent-${piece.poem}"` : "";
          return `<span${cls}>${escapeHtml(piece.text)}</span>`;
        }
        if (piece.noteId || piece.noteId === 0) {
          return `<sup title="See footnote ${piece.noteId + 1}">‚Ä†</sup>`;
        }
        return "";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateNavButtons() {
        selectors.prevBtn.disabled = !state.prevChapterLink;
        selectors.nextBtn.disabled = !state.nextChapterLink;
        selectors.prevBtnBottom.disabled = !state.prevChapterLink;
        selectors.nextBtnBottom.disabled = !state.nextChapterLink;
      }

      function navigateChapter(link) {
        if (!link) return;
        const parts = link.replace("/api/", "").replace(".json", "").split("/");
        const [, book, chapter] = parts;
        loadChapter(book, chapter);
      }

      function saveBookmark(verseNumber, excerpt) {
        if (!state.currentBook) return;
        const id = `${state.translationId}-${state.currentBook.id}-${state.currentChapter}-${verseNumber}`;
        if (state.bookmarks.some((b) => b.id === id)) return;
        const payload = {
          id,
          translation: state.translationId,
          book: state.currentBook.commonName,
          bookId: state.currentBook.id,
          chapter: state.currentChapter,
          verse: verseNumber,
          excerpt: excerpt.slice(0, 140),
          savedAt: Date.now(),
        };
        state.bookmarks.unshift(payload);
        persist(STORAGE_KEYS.bookmarks, state.bookmarks);
        renderBookmarks();
      }

      function renderBookmarks() {
        selectors.bookmarkList.innerHTML = state.bookmarks.length
          ? ""
          : '<p style="color: var(--muted);">No verses saved yet.</p>';
        state.bookmarks.forEach((bookmark) => {
          const node = selectors.bookmarkTemplate.content.cloneNode(true);
          node.querySelector(
            '[data-field="title"]'
          ).textContent = `${bookmark.book} ${bookmark.chapter}:${bookmark.verse}`;
          node.querySelector('[data-field="excerpt"]').textContent =
            bookmark.excerpt;
          node
            .querySelector("button")
            .addEventListener("click", () => removeBookmark(bookmark.id));
          node
            .querySelector(".bookmark-item")
            .addEventListener("click", () =>
              loadChapter(bookmark.bookId, bookmark.chapter)
            );
          selectors.bookmarkList.append(node);
        });
      }

      function removeBookmark(id) {
        state.bookmarks = state.bookmarks.filter((b) => b.id !== id);
        persist(STORAGE_KEYS.bookmarks, state.bookmarks);
        renderBookmarks();
      }

      function pushHistory(payload) {
        const record = {
          translation: payload.translation.id,
          book: payload.book.commonName,
          bookId: payload.book.id,
          chapter: payload.chapter.number,
          visitedAt: Date.now(),
        };
        state.history = [record, ...state.history].slice(0, 25);
        persist(STORAGE_KEYS.history, state.history);
        renderHistory();
        updateProgress();
      }

      function renderHistory() {
        selectors.historyList.innerHTML = state.history.length
          ? ""
          : '<p style="color: var(--muted);">No reading activity yet.</p>';
        state.history.forEach((item) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "ghost-btn";
          btn.style.justifyContent = "space-between";
          btn.innerHTML = `<span>${item.book} ${
            item.chapter
          }</span><small>${new Date(
            item.visitedAt
          ).toLocaleDateString()}</small>`;
          btn.addEventListener("click", () =>
            loadChapter(item.bookId, item.chapter)
          );
          selectors.historyList.append(btn);
        });
      }

      function updateProgress() {
        const uniqueChapters = new Set(
          state.history.map((item) => `${item.bookId}-${item.chapter}`)
        );
        const completed = uniqueChapters.size;
        const percent = Math.min((completed / 1189) * 100, 100);
        selectors.progressMeter.style.width = `${percent.toFixed(1)}%`;
        selectors.progressCopy.textContent = `${completed} of 1,189 chapters logged`;
      }

      function persist(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      function persistSettings() {
        const settings = JSON.parse(
          localStorage.getItem(STORAGE_KEYS.settings) || "{}"
        );
        settings.translationId = state.translationId;
        persist(STORAGE_KEYS.settings, settings);
      }
    </script>
  </body>
</html>
